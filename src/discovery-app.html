<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">

<link rel="import" href="components/app-location-ifrau.html">
<link rel="import" href="mixins/route-locations-mixin.html">

<link rel="lazy-import" href="discovery-home.html">
<link rel="lazy-import" href="discovery-404.html">
<link rel="lazy-import" href="discovery-course.html">
<link rel="lazy-import" href="discovery-manage.html">
<link rel="lazy-import" href="discovery-search.html">

<dom-module id="discovery-app">  
  <template>
    <style>
    </style>

    <app-location-ifrau
      route="{{route}}"
      query-params="{{queryParams}}">
    </app-location-ifrau>

    <app-route
      route="{{route}}"
      pattern="/d2l/le/discovery/view/:page"
      data="{{routeData}}"
      tail="{{subroute}}">
    </app-route>

    <iron-pages
      selected="[[routeData.page]]"
      attr-for-selected="name"
      selected-attribute="visible"
      fallback-selection="discovery-404"
      role="main">
      <discovery-home
        name="home"
        route="{{route}}">
      </discovery-home>

      <discovery-404 name="404"></discovery-404>

      <discovery-search
        name="search"
        route="{{route}}"
        query-params="{{queryParams}}">
      </discovery-search>

      <discovery-manage
        name="manage"
        route="{{route}}">
      </discovery-manage>

      <discovery-course
        name="course"
        route="{{route}}">
      </discovery-course>
    </iron-pages>
  </template>

  <script>
    // Gesture events like tap and track generated from touch will not be
    // preventable, allowing for better scrolling performance.
    Polymer.setPassiveTouchGestures(true);

    class DiscoveryApp extends D2L.Discovery.RouteLocationsMixin(Polymer.Element) {

      static get is() { return 'discovery-app'; }

      static get properties() {
        return {
          route: Object,
          page: {
            type: String,
            reflectToAttribute: true,
            observer: '_pageChanged',
          },
          routeData: Object,
          subroute: Object,
          // This shouldn't be neccessary, but the Analyzer isn't picking up
          // Polymer.Element#rootPath
          rootPath: String,
          path: {
            type: String,
          },
          queryParams: {
            type: Object,
            notify: true,
          },
        };
      }

      static get observers() {
        return [
          '_routePathChanged(route.path)',
          '_routeDataPageChanged(routeData.page)',
        ];
      }

      ready() {
        super.ready();
        this.addEventListener('navigate', this._navigate);
      }

      _navigate(e) {
        if (e && e.detail && e.detail.path) {
          this.set('route.path', e.detail.path);
        }
      }

      _routePathChanged(path) {
        if (path === '/d2l/le/discovery/view/') { // navlink home
          var appLocationIfrau = this.shadowRoot.querySelector('app-location-ifrau');
          if (appLocationIfrau) {
            appLocationIfrau.rewriteTo(this.routeLocations().home());
          }
        }
      }

      _routeDataPageChanged(page) { // this allows us to lazy-import when routeData.page changes
        if (page) {
          this.page = page;
        }
      }

      _pageChanged(page) {
        const resolvedPageUrl = this.resolveUrl('discovery-' + page + '.html');
        Polymer.importHref(
          resolvedPageUrl,
          null,
          this._showPage404.bind(this),
          true);
      }

      _showPage404() {
        this.set('routeData.page', '404');
      }
    }

    window.customElements.define(DiscoveryApp.is, DiscoveryApp);
  </script>
</dom-module>
