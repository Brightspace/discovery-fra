<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../mixins/localize-mixin.html">
<link rel="import" href="../mixins/route-locations-mixin.html">

<link rel="import" href="../styles/discovery-styles.html">

<link rel="import" href="search-result-entry.html">

<link rel="import" href="../../bower_components/d2l-icons/d2l-icon.html">
<link rel="import" href="../../bower_components/d2l-icons/tier1-icons.html">

<link rel="import" href="../../bower_components/d2l-dropdown/d2l-dropdown.html">
<link rel="import" href="../../bower_components/d2l-dropdown/d2l-dropdown-menu.html">
<link rel="import" href="../../bower_components/d2l-menu/d2l-menu.html">
<link rel="import" href="../../bower_components/d2l-menu/d2l-menu-item-link.html">

<dom-module id="search-results">
  <template>
    <style include="discovery-styles"></style>
    <style>
      :host {
        display: inline;
      }

      .container {
        display: flex;
        flex-direction: column;
      }

      .header {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        align-items: baseline;
        justify-content: space-between;
        padding-bottom: 0.5rem;
      }

      .sortBy {
        display: flex;
        align-items: baseline;
        flex-shrink: 0;
      }

      .searchMessage {
        flex-shrink: 0;
        width: 60%;
        padding-right: 1rem;
        padding-bottom: 1rem;
      }

      .dropdown {
        cursor: pointer;
      }

      .dropdownIcon {
        margin-left: 0.5rem;
      }

      .dropdownText {
        margin-left: 0.25rem;
      }

      .searchResult {
        margin-bottom: 2rem;
      }

    </style>

    <div class="d2l-typography">
      <template is="dom-if" if="[[!searchResultsExists]]">
        <h4 class="d2l-heading-4">0 [[localize('resultsFor')]] [[searchQuery]]</h4>
      </template>

      <template is="dom-if" if="[[searchResultsExists]]">
        <div class="header">
          <span class="d2l-label-text searchMessage">[[searchResultsRangeToString]] [[localize('of')]] [[searchResultsTotal]] [[localize('resultsFor')]] "[[searchQuery]]"</span>
          <div class="sortBy">
            <span class="d2l-label-text">[[localize('sortBy')]]:</span>
            
            <d2l-dropdown>
              <span class="d2l-dropdown-opener d2l-label-text dropdown">
                <span class="dropdownText">[[localize('relevance')]]</span>
                <d2l-icon class="dropdownIcon" icon="d2l-tier1:chevron-down"></d2l-icon>
              </span>
              <d2l-dropdown-menu>
                <d2l-menu label="Sort By">
                  <d2l-menu-item-link text="Relevance" href="javascript:void(0)" on-click="_menuItemSelected"></d2l-menu-item-link>
                  <d2l-menu-item-link text="New" href="javascript:void(0)" on-click="_menuItemSelected"></d2l-menu-item-link>
                </d2l-menu>
              </d2l-dropdown-menu>
            </d2l-dropdown>
          </div>
        </div>

        <div class="container">
          <template is="dom-repeat" items="[[searchResults.results]]">
            <div class="searchResult">
              <search-result-entry
                course-id="{{item.id}}"
                course-title="[[item.title]]"
                course-description="[[item.description]]"
                course-thumbnail-link="[[item.thumbnail]]"
                course-duration="[[item.duration]]"
                course-tags="[[item.tags]]">
              </search-result-entry>
            </div>
          </template>
        </div>

        <!-- <div id="pagination">
          <button on-click="_doNext">Next</button>
        </div> -->
      </template>
    </div>
  </template>

  <script>
    class SearchResults extends
      D2L.Discovery.LocalizeMixin(
      D2L.Discovery.RouteLocationsMixin(Polymer.Element)) {

      constructor() {
        super();
      }

      static get is() { return 'search-results'; }

      static get properties() {
        return {
          searchQuery: String,
          searchResults: Object,
          searchResultsExists: {
            type: Boolean,
            computed: '_computeSearchResultsExist(searchResults)'
          },
          searchResultsRangeToString: {
            type: String,
            computed: '_computeSearchResultsRange(searchResults)',
          },
          searchResultsTotal: {
            type: Number,
            computed: '_computeTotalSizeOfSearchResults(searchResults)',
          },

          actualResults: {
            type: Array,
            computed: '_getResults(searchResults)',
          }
        };
      }

      _getResults(searchResults) {
        if (searchResults) {
          return searchResults.results;
        }
        return [];
      }
      _computeTotalSizeOfSearchResults(searchResults) {
        return searchResults && searchResults.metadata && searchResults.metadata.total;
      }

      _computeSearchResultsExist(searchResults) {
        return searchResults && searchResults.results && searchResults.results.length > 0;
      }

      _computeSearchResultsRange(searchResults) {
        if (searchResults &&
          searchResults.metadata &&
          searchResults.metadata.startIndex !== undefined &&
          searchResults.metadata.size !== undefined) {
            const startIndex = searchResults.metadata.startIndex + 1;
            const endIndex = searchResults.metadata.startIndex + searchResults.metadata.size;
            return `${startIndex}-${endIndex}`;
          }
        return '';
      }

      _menuItemSelected(e) {
        console.log('>> got d2l-menu-item-select event e.target.text:', e.target.text);
      }

      _doNext(e) {
        console.log('do next!');
        this.dispatchEvent(new CustomEvent('search-next', {
          detail: {
          },
          bubbles: true,
          composed: true,
        }));
      }
    }

    window.customElements.define(SearchResults.is, SearchResults);
  </script>
</dom-module>
