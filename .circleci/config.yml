version: 2

references:
  workspace_root: &workspace_root
    ./
        
  node_container: &node_container
    docker:
      - image: dmoscrop/circleci-node8.10-tfenv

  attach_workspace: &attach_workspace
    attach_workspace:
      at: *workspace_root


jobs:
  build:
    dependencies:
      <<: *node_container

    steps:
      - checkout
      - run: npm install
      - run: npm run build
  
  publish: 
    dependencies:
      <<: *node_container
    
    steps:
      - *attach_workspace
      - run: npm run frau:publish
    
  release:
    dependencies:
      <<: *node_container
    
    steps:
      - *attach_workspace
      - run: npm run frau:release

workflows:
  version: 2

  build-and-publish:
    jobs:
      - build
      - publish:
          requires:
            - build
  
  release:
    jobs:
      - build
      - release:
          requires:
            - build
          filters:
            branches:
              only:
                - /^release.*/